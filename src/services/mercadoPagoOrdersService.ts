// src/services/mercadoPagoOrdersService.ts
/**
 * Servicio para integraci√≥n con Mercado Pago Point usando Orders API (v1/orders)
 * Documentaci√≥n: https://www.mercadopago.com.mx/developers/es/reference/in-person-payments/point/orders
 * 
 * Este servicio implementa la API v1/orders seg√∫n la documentaci√≥n oficial.
 * Los logs est√°n preparados para despu√©s guardar en Firebase/Firestore.
 */

import { savePayment } from './firestoreService';

// ========================================
// TIPOS Y INTERFACES
// ========================================

// Configuraci√≥n de Mercado Pago
interface MercadoPagoConfig {
  accessToken: string;
  userId: string;
  environment: 'production' | 'sandbox';
}

// Configuraci√≥n de terminales
export interface Terminal {
  id: string;
  name: string;
  location: string;
  storeId: string;  // ID de la tienda en Mercado Pago
  posId: string;    // ID del punto de venta (cada terminal f√≠sica tiene uno)
  externalId: string; // ID externo para tu aplicaci√≥n
  enabled?: boolean; // Si la terminal est√° habilitada para usar en el sistema
  customName?: string; // Nombre personalizado por el usuario
  operatingMode?: 'PDV' | 'STANDALONE'; // Modo de operaci√≥n actual de la terminal
}

// Respuesta de la API de dispositivos
interface MercadoPagoDevice {
  id: string;
  pos_id: number;
  store_id: string;
  external_pos_id: string;
  operating_mode: 'PDV' | 'STANDALONE';
}

interface MercadoPagoDevicesResponse {
  devices: MercadoPagoDevice[];
  paging: {
    total: number;
    limit: number;
    offset: number;
  };
}

export interface PaymentOrderRequest {
  amount: number;
  description?: string; // Ahora opcional, se generar√° autom√°ticamente
  externalReference?: string; // Ahora opcional, se generar√° autom√°ticamente
  terminalId: string;
  expirationTime?: string; // ISO 8601 format (ej: "PT3M" = 3 minutos)
  printOnTerminal?: 'seller_ticket' | 'client_ticket' | 'both' | 'none';
  
  // Datos opcionales para generar external_reference y description
  orderId?: string; // ID de la orden (para orders/ID) o 'setting' para pruebas
  waiterName?: string; // Nombre del mesero
  userData?: { // Datos del usuario que hace el cobro (para guardar en Firestore)
    id: string;
    displayName: string;
    email: string;
    role: string;
  };
}

export interface PaymentOrderResponse {
  id: string;
  type: string;
  status: 'created' | 'at_terminal' | 'processing' | 'processed' | 'paid' | 'canceled' | 'expired' | 'failed';
  statusDetail: string;
  externalReference: string;
  description: string;
  amount: number;
  currency: string;
  createdDate: string;
  lastUpdatedDate: string;
  paymentId?: string;
  paymentStatus?: string;
  referenceId?: string; // ‚Üê NUEVO: Para certificaci√≥n con Mercado Pago
  errorMessage?: string;
  
  // Datos para guardar en BD despu√©s
  rawResponse?: any; // Respuesta completa de la API
}

export interface PaymentStatusResponse {
  id: string;
  status: 'created' | 'at_terminal' | 'processing' | 'processed' | 'paid' | 'canceled' | 'expired' | 'failed';
  statusDetail: string;
  paymentId?: string;
  paymentStatus?: string;
  paymentStatusDetail?: string; // ‚Üê NUEVO: Detalle del estado del pago (ej: "accredited", "in_review")
  referenceId?: string; // ‚Üê NUEVO: Para certificaci√≥n con Mercado Pago
  amount?: number;
  errorMessage?: string;
  
  // Datos para guardar en BD despu√©s
  rawResponse?: any; // Respuesta completa de la API
}

// ========================================
// CONFIGURACI√ìN
// ========================================

const CONFIG: MercadoPagoConfig = {
  accessToken: import.meta.env.VITE_MERCADOPAGO_ACCESS_TOKEN || 'TEST-YOUR-ACCESS-TOKEN-HERE',
  userId: import.meta.env.VITE_MERCADOPAGO_USER_ID || 'YOUR-USER-ID',
  environment: (import.meta.env.VITE_MERCADOPAGO_ENV as 'production' | 'sandbox') || 'sandbox',
};

// Configuraci√≥n de terminales f√≠sicas
// ‚úÖ Configurado con datos reales de Mercado Pago
// NOTA: Esta configuraci√≥n es para fallback. Las terminales se obtienen din√°micamente de la API.
const TERMINALS: Terminal[] = [
  {
    id: 'NEWLAND_N950__N950NCC303060763',  // Device ID completo de la API
    name: 'Terminal Casa Pedre - Cuarto',
    location: 'Cuarto',
    storeId: '75133024',                    // Store ID real de la API
    posId: '119553847',                     // POS ID real de la API
    externalId: 'BAR-POS-CASA-PEDRE-CUARTO'
  },
];

const getBaseUrl = () => {
  // Siempre usar /api/mercadopago
  // En desarrollo: Vite proxy (vite.config.ts)
  // En producci√≥n: Firebase Function (firebase.json rewrite)
  return '/api/mercadopago';
};

// ========================================
// FUNCIONES DE TERMINALES
// ========================================

/**
 * Obtiene la configuraci√≥n de una terminal por su ID
 */
export const getTerminal = (terminalId: string): Terminal | undefined => {
  return TERMINALS.find(t => t.id === terminalId);
};

/**
 * Obtiene todas las terminales disponibles (configuradas manualmente)
 */
export const getAvailableTerminals = (): Terminal[] => {
  return TERMINALS;
};

/**
 * Obtiene las terminales reales desde la API de Mercado Pago
 * @returns Array de dispositivos Point registrados en tu cuenta
 */
export const fetchRealTerminals = async (): Promise<MercadoPagoDevice[]> => {
  const endpoint = '/point/integration-api/devices';
  
  try {
    // console.log('üîç [MercadoPago] Obteniendo terminales registradas...');
    
    const response = await apiRequest<MercadoPagoDevicesResponse>(endpoint, 'GET');
    
    // console.log(`‚úÖ [MercadoPago] ${response.devices?.length || 0} terminales encontradas`);
    return response.devices || [];
  } catch (error: any) {
    console.error('‚ùå [MercadoPago] Error al obtener terminales:', error);
    return [];
  }
};

/**
 * Cambia el modo de operaci√≥n de una terminal
 * @param deviceId - ID de la terminal
 * @param mode - Modo de operaci√≥n: 'PDV' (recibe √≥rdenes desde API) o 'STANDALONE' (solo pagos manuales)
 * @returns true si el cambio fue exitoso
 */
export const setTerminalOperatingMode = async (
  deviceId: string,
  mode: 'PDV' | 'STANDALONE'
): Promise<{ success: boolean; error?: string }> => {
  const endpoint = `/point/integration-api/devices/${deviceId}`;
  
  try {
    // console.log(`üîÑ [MercadoPago] Cambiando terminal ${deviceId} a modo ${mode}...`);
    
    const response = await apiRequest<{ id: string; operating_mode: string }>(
      endpoint,
      'PATCH' as any, // TypeScript fix
      { operating_mode: mode }
    );
    
    // console.log(`‚úÖ [MercadoPago] Terminal ${deviceId} ahora en modo ${response.operating_mode}`);
    return { success: true };
  } catch (error: any) {
    console.error(`‚ùå [MercadoPago] Error al cambiar modo de terminal ${deviceId}:`, error);
    return { 
      success: false, 
      error: error?.message || 'Error al cambiar modo de operaci√≥n'
    };
  }
};

/**
 * Obtiene las terminales reales formateadas como Terminal[]
 * @param enabledConfig - Opcional: objeto con la configuraci√≥n de terminales habilitadas
 * @param namesConfig - Opcional: objeto con nombres personalizados de terminales
 */
export const getFormattedTerminals = async (
  enabledConfig?: Record<string, boolean>,
  namesConfig?: Record<string, string>
): Promise<Terminal[]> => {
  const devices = await fetchRealTerminals();
  
  return devices.map((device) => ({
    id: device.id,
    name: `Terminal ${device.id.split('__')[1] || device.id}`, // Extraer parte legible del ID
    location: device.operating_mode === 'PDV' ? 'Punto de Venta' : 'Standalone',
    storeId: device.store_id,
    posId: device.pos_id.toString(),
    externalId: device.external_pos_id || `BAR-POS-${device.id}`,
    enabled: enabledConfig ? (enabledConfig[device.id] !== false) : true, // Por defecto habilitadas
    customName: namesConfig?.[device.id], // Nombre personalizado si existe
    operatingMode: device.operating_mode // Modo de operaci√≥n actual desde la API
  }));
};

/**
 * Obtiene solo las terminales habilitadas
 */
export const getEnabledTerminals = async (
  enabledConfig?: Record<string, boolean>,
  namesConfig?: Record<string, string>
): Promise<Terminal[]> => {
  const allTerminals = await getFormattedTerminals(enabledConfig, namesConfig);
  return allTerminals.filter(t => t.enabled !== false);
};

// ========================================
// FUNCIONES AUXILIARES API
// ========================================

/**
 * Realiza una petici√≥n a la API de Mercado Pago
 */
const apiRequest = async <T>(
  endpoint: string,
  method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE' = 'GET',
  body?: any
): Promise<T> => {
  const url = `${getBaseUrl()}${endpoint}`;
  
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
  };

  // Solo agregar Authorization en producci√≥n (cuando no usamos proxy)
  if (!import.meta.env.DEV) {
    headers['Authorization'] = `Bearer ${CONFIG.accessToken}`;
  }
  
  // Agregar X-Idempotency-Key para POST/PUT/PATCH/DELETE
  if (method !== 'GET') {
    headers['X-Idempotency-Key'] = `${Date.now()}-${Math.random().toString(36).substring(7)}`;
  }

  const options: RequestInit = {
    method,
    headers,
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  try {
    // console.log(`üåê [MercadoPago Orders API] ${method} ${endpoint}`, body || '');
    
    const response = await fetch(url, options);
    const data = await response.json();

    if (!response.ok) {
      console.error(`‚ùå [MercadoPago Orders API] HTTP ${response.status}:`, data);
      throw new Error(data.message || `Error ${response.status}: ${response.statusText}`);
    }

    // console.log('‚úÖ [MercadoPago Orders API] Response:', data);
    return data;
  } catch (error: any) {
    console.error('‚ùå [MercadoPago Orders API] Request failed:', error);
    throw error;
  }
};

// ========================================
// FUNCIONES PRINCIPALES
// ========================================

/**
 * Crea una orden de pago en la terminal Point usando v1/orders API
 * Documentaci√≥n: https://www.mercadopago.com.mx/developers/es/reference/in-person-payments/point/orders/create-order/post
 * 
 * @param request - Datos de la orden de pago
 * @returns Respuesta con el ID de la orden
 */
export const createPaymentOrder = async (
  request: PaymentOrderRequest
): Promise<PaymentOrderResponse> => {
  const terminal = getTerminal(request.terminalId);
  
  if (!terminal) {
    throw new Error(`Terminal no encontrada: ${request.terminalId}`);
  }

  // Validar monto m√≠nimo de $5.00 MXN
  if (request.amount < 5) {
    throw new Error(`El monto m√≠nimo para cobrar es $5.00 MXN (recibido: $${request.amount.toFixed(2)})`);
  }

  // ========================================
  // GENERAR EXTERNAL REFERENCE Y DESCRIPTION
  // ========================================
  
  // Formato: IDORDER-NombreMesero-Total-DD-MM-AA
  // Ejemplo: ORDER123-Juan-200-12-10-25 o setting-Admin-5-12-10-25
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = String(now.getFullYear()).slice(-2);
  
  const orderId = request.orderId || 'setting';
  const waiterName = request.waiterName || request.userData?.displayName || 'Usuario';
  const total = Math.round(request.amount);
  
  const externalReference = request.externalReference || 
    `${orderId}-${waiterName}-${total}-${day}-${month}-${year}`;
  
  // Formato: CHEPECHUPES-IDORDER
  // Ejemplo: CHEPECHUPES-ORDER123 o CHEPECHUPES-setting
  const description = request.description || 
    `CHEPECHUPES-${orderId}`;

  console.log(`üí≥ [MercadoPago Orders API] üöÄ INICIANDO CREACI√ìN DE ORDEN`);
  console.log(`üìä [MercadoPago Orders API] Datos de la orden:`, {
    amount: request.amount,
    terminal: terminal.name,
    terminalId: request.terminalId,
    externalReference: externalReference,
    description: description,
    orderId: orderId,
    waiterName: waiterName
  });

  // Endpoint para crear orden de pago
  const endpoint = `/v1/orders`;

  // Payload seg√∫n documentaci√≥n oficial
  const payload = {
    type: "point",
    external_reference: externalReference,
    description: description,
    expiration_time: request.expirationTime || "PT5M", // Default: 5 minutos
    transactions: {
      payments: [
        {
          amount: request.amount.toFixed(2) // String con 2 decimales
        }
      ]
    },
    config: {
      point: {
        terminal_id: request.terminalId,
        print_on_terminal: request.printOnTerminal || "seller_ticket"
      }
    }
  };

  try {
    // console.log(`üì§ [MercadoPago Orders API] Enviando payload:`, JSON.stringify(payload, null, 2));

    const response = await apiRequest<any>(endpoint, 'POST', payload);

    // üîç LOG COMPLETO DE LA RESPUESTA
    // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ‚úÖ‚úÖ ORDEN CREADA EXITOSAMENTE ‚úÖ‚úÖ‚úÖ`);
    // console.log(`üìã [MercadoPago Orders API] üìã RESPUESTA COMPLETA:`, JSON.stringify(response, null, 2));
    // console.log(`üÜî [MercadoPago Orders API] Order ID: ${response.id}`);
    // console.log(`üìä [MercadoPago Orders API] Status: ${response.status}`);
    // console.log(`üìä [MercadoPago Orders API] Status Detail: ${response.status_detail}`);
    // console.log(`üí∞ [MercadoPago Orders API] Amount: ${response.transactions?.payments?.[0]?.amount}`);
    // console.log(`üîó [MercadoPago Orders API] External Reference: ${response.external_reference}`);
    // console.log(`üè™ [MercadoPago Orders API] Terminal ID: ${response.config?.point?.terminal_id}`);
    
    // Extraer payment ID si existe
    const paymentId = response.transactions?.payments?.[0]?.id;
    const paymentStatus = response.transactions?.payments?.[0]?.status;
    
    if (paymentId) {
      // console.log(`üí≥ [MercadoPago Orders API] Payment ID: ${paymentId}`);
      // console.log(`üí≥ [MercadoPago Orders API] Payment Status: ${paymentStatus}`);
    }

    // ========================================
    // GUARDAR EN FIRESTORE
    // ========================================
    if (request.userData) {
      // console.log(`üíæ [MercadoPago Orders API] üíæ GUARDANDO EN FIRESTORE üíæ`);
      
      try {
        const saveResult = await savePayment(response, request.userData);
        
        if (saveResult.success) {
          // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ Pago guardado en Firestore correctamente`);
        } else {
          console.error(`‚ö†Ô∏è [MercadoPago Orders API] Error al guardar en Firestore:`, saveResult.error);
        }
      } catch (error) {
        console.error(`‚ùå [MercadoPago Orders API] Error al guardar en Firestore:`, error);
      }
    } else {
      // console.log(`‚ö†Ô∏è [MercadoPago Orders API] No se guardar√° en Firestore (no hay userData)`);
    }

    return {
      id: response.id,
      type: response.type,
      status: response.status,
      statusDetail: response.status_detail,
      externalReference: response.external_reference,
      description: response.description,
      amount: parseFloat(response.transactions?.payments?.[0]?.amount || '0'),
      currency: response.currency,
      createdDate: response.created_date,
      lastUpdatedDate: response.last_updated_date,
      paymentId,
      paymentStatus,
      rawResponse: response // Guardar respuesta completa para BD
    };
  } catch (error: any) {
    console.error('‚ùå [MercadoPago Orders API] ‚ùå‚ùå‚ùå ERROR AL CREAR ORDEN ‚ùå‚ùå‚ùå');
    console.error('‚ùå [MercadoPago Orders API] Error completo:', JSON.stringify(error, null, 2));
    console.error('‚ùå [MercadoPago Orders API] Error message:', error.message);
    console.error('‚ùå [MercadoPago Orders API] Error stack:', error.stack);
    
    throw new Error(`No se pudo crear la orden de pago: ${error.message}`);
  }
};

/**
 * Consulta el estado de una orden de pago
 * Documentaci√≥n: https://www.mercadopago.com.mx/developers/es/reference/in-person-payments/point/orders/get-order/get
 * 
 * @param orderId - ID de la orden
 * @returns Estado actual de la orden
 */
export const getOrderStatus = async (
  orderId: string
): Promise<PaymentStatusResponse> => {
  // console.log(`üîç [MercadoPago Orders API] üîç CONSULTANDO ESTADO DE ORDEN: ${orderId}`);

  const endpoint = `/v1/orders/${orderId}`;

  try {
    const response = await apiRequest<any>(endpoint, 'GET');
    
    // üîç LOG COMPLETO DE LA RESPUESTA
    // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ ESTADO OBTENIDO ‚úÖ`);
    // console.log(`üìã [MercadoPago Orders API] üìã RESPUESTA COMPLETA:`, JSON.stringify(response, null, 2));
    // console.log(`üÜî [MercadoPago Orders API] Order ID: ${response.id}`);
    // console.log(`üìä [MercadoPago Orders API] Status: ${response.status}`);
    // console.log(`üìä [MercadoPago Orders API] Status Detail: ${response.status_detail}`);
    // console.log(`üí∞ [MercadoPago Orders API] Amount: ${response.transactions?.payments?.[0]?.amount}`);
    
    // Extraer payment info
    const paymentId = response.transactions?.payments?.[0]?.id;
    const paymentStatus = response.transactions?.payments?.[0]?.status;
    const paymentStatusDetail = response.transactions?.payments?.[0]?.status_detail;
    const referenceId = response.transactions?.payments?.[0]?.reference_id;
    
    if (paymentId) {
      // console.log(`üí≥ [MercadoPago Orders API] Payment ID: ${paymentId}`);
      // console.log(`üí≥ [MercadoPago Orders API] Payment Status: ${paymentStatus}`);
      // console.log(`üí≥ [MercadoPago Orders API] Payment Status Detail: ${paymentStatusDetail}`);
      // console.log(`üî¢ [MercadoPago Orders API] Reference ID: ${referenceId}`);
    }

    // TODO: Aqu√≠ se actualizar√° en BD despu√©s
    console.log(`üíæ [MercadoPago Orders API] üíæ TODO: ACTUALIZAR EN BD üíæ`);
    console.log(`üíæ [MercadoPago Orders API] Datos para actualizar:`, {
      orderId: response.id,
      status: response.status,
      statusDetail: response.status_detail,
      paymentId,
      paymentStatus,
      paymentStatusDetail,
      referenceId,
      lastUpdatedDate: response.last_updated_date,
      rawResponse: response
    });

    return {
      id: response.id,
      status: response.status,
      statusDetail: response.status_detail,
      paymentId,
      paymentStatus,
      paymentStatusDetail,
      referenceId,
      amount: parseFloat(response.transactions?.payments?.[0]?.amount || '0'),
      rawResponse: response // Guardar respuesta completa para BD
    };
  } catch (error: any) {
    console.error('‚ùå [MercadoPago Orders API] ‚ùå‚ùå‚ùå ERROR AL CONSULTAR ESTADO ‚ùå‚ùå‚ùå');
    console.error('‚ùå [MercadoPago Orders API] Error completo:', JSON.stringify(error, null, 2));
    console.error('‚ùå [MercadoPago Orders API] Error message:', error.message);
    
    throw new Error(`No se pudo consultar el estado de la orden: ${error.message}`);
  }
};

/**
 * Cancela una orden de pago pendiente
 * Documentaci√≥n: https://www.mercadopago.com.mx/developers/es/reference/in-person-payments/point/orders/cancel-order/post
 * 
 * @param orderId - ID de la orden a cancelar
 */
export const cancelPaymentOrder = async (
  orderId: string
): Promise<void> => {
  // console.log(`üö´ [MercadoPago Orders API] üö´ CANCELANDO ORDEN: ${orderId}`);

  const endpoint = `/v1/orders/${orderId}/cancel`;

  try {
    const response = await apiRequest<any>(endpoint, 'POST');
    
    // üîç LOG COMPLETO DE LA RESPUESTA
    // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ ORDEN CANCELADA ‚úÖ`);
    // console.log(`üìã [MercadoPago Orders API] üìã RESPUESTA COMPLETA:`, JSON.stringify(response, null, 2));
    // console.log(`üÜî [MercadoPago Orders API] Order ID: ${response.id}`);
    // console.log(`üìä [MercadoPago Orders API] Status: ${response.status}`);
    // console.log(`üìä [MercadoPago Orders API] Status Detail: ${response.status_detail}`);

    // TODO: Aqu√≠ se actualizar√° en BD despu√©s
    console.log(`üíæ [MercadoPago Orders API] üíæ TODO: ACTUALIZAR EN BD üíæ`);
    console.log(`üíæ [MercadoPago Orders API] Datos para actualizar:`, {
      orderId: response.id,
      status: 'canceled',
      statusDetail: response.status_detail,
      canceledDate: response.last_updated_date,
      rawResponse: response
    });
  } catch (error: any) {
    console.error('‚ùå [MercadoPago Orders API] ‚ùå‚ùå‚ùå ERROR AL CANCELAR ORDEN ‚ùå‚ùå‚ùå');
    console.error('‚ùå [MercadoPago Orders API] Error completo:', JSON.stringify(error, null, 2));
    console.error('‚ùå [MercadoPago Orders API] Error message:', error.message);
    
    throw new Error(`No se pudo cancelar la orden: ${error.message}`);
  }
};

/**
 * Procesa un pago completo con polling de estado
 * Esta es una funci√≥n de alto nivel que maneja todo el flujo
 * 
 * @param request - Datos del pago
 * @param onStatusChange - Callback para actualizar el estado en la UI
 * @returns Resultado final del pago
 */
export const processPayment = async (
  request: PaymentOrderRequest,
  onStatusChange?: (status: string, message: string) => void
): Promise<PaymentOrderResponse> => {
  try {
    // console.log(`üöÄ [MercadoPago Orders API] üöÄüöÄüöÄ INICIANDO PROCESO DE PAGO üöÄüöÄüöÄ`);
    
    // 1. Crear orden de pago
    onStatusChange?.('sending', 'Enviando orden a la terminal...');
    const order = await createPaymentOrder(request);

    if (!order.id) {
      throw new Error('No se obtuvo ID de la orden');
    }

    // console.log(`‚úÖ [MercadoPago Orders API] Orden creada: ${order.id}`);

    // 2. Hacer polling del estado cada 5 segundos (m√°ximo 90 segundos)
    onStatusChange?.('processing', 'Esperando pago del cliente en la terminal...');
    
    const maxAttempts = 18; // 18 intentos x 5 segundos = 90 segundos
    let attempts = 0;
    let finalStatus: PaymentStatusResponse | null = null;

    while (attempts < maxAttempts) {
      attempts++;
      // console.log(`üîÑ [MercadoPago Orders API] Polling intento ${attempts}/${maxAttempts}`);
      
      await new Promise(resolve => setTimeout(resolve, 5000)); // Esperar 5 segundos

      try {
        const status = await getOrderStatus(order.id);
        finalStatus = status;

        // console.log(`üìä [MercadoPago Orders API] Estado actual: ${status.status} (${status.statusDetail})`);
        
        // Actualizar UI con countdown
        const remainingSeconds = (maxAttempts - attempts) * 5;
        onStatusChange?.('processing', `Esperando pago del cliente... (${remainingSeconds}s)`);

        // Verificar si el pago fue aprobado, rechazado o cancelado
        // La API puede devolver 'processed' o 'paid' para pagos exitosos
        if (status.status === 'paid' || status.status === 'processed') {
          // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ‚úÖ‚úÖ PAGO APROBADO ‚úÖ‚úÖ‚úÖ`);
          // console.log(`üí≥ [MercadoPago Orders API] Payment Status: ${status.paymentStatus}`);
          // console.log(`üí≥ [MercadoPago Orders API] Status Detail: ${status.paymentStatusDetail}`);
          // console.log(`üî¢ [MercadoPago Orders API] Reference ID: ${status.referenceId}`);
          onStatusChange?.('success', '¬°Pago procesado exitosamente!');
          break;
        } else if (status.status === 'failed') {
          // console.log(`‚ùå [MercadoPago Orders API] ‚ùå‚ùå‚ùå PAGO RECHAZADO/FALLIDO ‚ùå‚ùå‚ùå`);
          // console.log(`üí≥ [MercadoPago Orders API] Payment Status: ${status.paymentStatus}`);
          // console.log(`üí≥ [MercadoPago Orders API] Status Detail: ${status.paymentStatusDetail}`);
          // console.log(`üî¢ [MercadoPago Orders API] Reference ID: ${status.referenceId}`);
          onStatusChange?.('rejected', status.statusDetail || 'Pago rechazado');
          break;
        } else if (status.status === 'canceled') {
          // console.log(`‚ùå [MercadoPago Orders API] Pago cancelado`);
          onStatusChange?.('rejected', 'Pago cancelado');
          break;
        } else if (status.status === 'expired') {
          // console.log(`‚ùå [MercadoPago Orders API] Orden expirada`);
          onStatusChange?.('error', 'Tiempo l√≠mite excedido');
          break;
        }
      } catch (error: any) {
        console.warn(`‚ö†Ô∏è [MercadoPago Orders API] Error en polling (intento ${attempts}):`, error.message);
        
        // Si es rate limit (429), esperar 10 segundos extra
        if (error.message?.includes('Too Many Requests') || error.message?.includes('429')) {
          // console.log(`‚è≥ [MercadoPago Orders API] Rate limit - esperando 10s extra...`);
          await new Promise(resolve => setTimeout(resolve, 10000));
        }
      }
    }

    // 3. Retornar resultado final
    if (!finalStatus || (finalStatus.status !== 'paid' && finalStatus.status !== 'processed' && finalStatus.status !== 'failed' && finalStatus.status !== 'canceled' && finalStatus.status !== 'expired')) {
      // console.log(`‚è±Ô∏è [MercadoPago Orders API] Timeout - no se obtuvo respuesta del cliente`);
      onStatusChange?.('error', 'Tiempo l√≠mite excedido. Verifica el estado en Mercado Pago.');
      throw new Error('Timeout: No se recibi√≥ confirmaci√≥n del pago');
    }

    // ========================================
    // ACTUALIZAR EN FIRESTORE CON ESTADO FINAL
    // ========================================
    if (request.userData && finalStatus.rawResponse) {
      // console.log(`üíæ [MercadoPago Orders API] üíæ ACTUALIZANDO ESTADO FINAL EN FIRESTORE üíæ`);
      
      try {
        const saveResult = await savePayment(finalStatus.rawResponse, request.userData);
        
        if (saveResult.success) {
          // console.log(`‚úÖ [MercadoPago Orders API] ‚úÖ Estado final guardado en Firestore correctamente`);
        } else {
          console.error(`‚ö†Ô∏è [MercadoPago Orders API] Error al actualizar en Firestore:`, saveResult.error);
        }
      } catch (error) {
        console.error(`‚ùå [MercadoPago Orders API] Error al actualizar en Firestore:`, error);
      }
    }

    // Actualizar el objeto de orden con el estado final
    return {
      ...order,
      status: finalStatus.status,
      statusDetail: finalStatus.statusDetail,
      paymentId: finalStatus.paymentId,
      paymentStatus: finalStatus.paymentStatus,
      referenceId: finalStatus.referenceId,
      rawResponse: finalStatus.rawResponse
    };

  } catch (error: any) {
    console.error('‚ùå [MercadoPago Orders API] ‚ùå‚ùå‚ùå ERROR EN PROCESO DE PAGO ‚ùå‚ùå‚ùå');
    console.error('‚ùå [MercadoPago Orders API] Error:', error);
    onStatusChange?.('error', error.message || 'Error procesando el pago');
    throw error;
  }
};

// ========================================
// EXPORT DE CONFIGURACI√ìN
// ========================================
export { TERMINALS, CONFIG };
